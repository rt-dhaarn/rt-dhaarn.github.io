<!doctype html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            DhaaRn - Devices for Harmonious Alignment Aware Resonant Nexus
        </title>

        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>


        <link rel="icon" type="image/png" href="Dhaarn_Logo.png" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <style>
            body {
                font-family: "Inter", sans-serif;
                background-color: #050505;
                color: #e2e8f0;
            }

            /* --- DhaaRn Core Styles --- */
            .gradient-text {
                background: linear-gradient(
                    to right,
                    #fcd34d,
                    #2dd4bf,
                    #ef4444
                );
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                text-fill-color: transparent;
            }

            .hero-glow {
                text-shadow:
                    0 0 20px rgba(212, 175, 55, 0.3),
                    0 0 40px rgba(153, 27, 27, 0.4);
            }

            .glass-card {
                background: rgba(20, 20, 20, 0.6);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(212, 175, 55, 0.1);
                border-radius: 1rem;
            }

            /* Animated Background */
            body::before {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: -1;
                background:
                    radial-gradient(
                        circle at 20% 20%,
                        rgba(212, 175, 55, 0.08),
                        transparent 30%
                    ),
                    radial-gradient(
                        circle at 80% 70%,
                        rgba(153, 27, 27, 0.1),
                        transparent 35%
                    );
                animation: pulse-glow 15s infinite alternate;
            }

            @keyframes pulse-glow {
                0% {
                    opacity: 0.6;
                    transform: scale(1);
                }
                100% {
                    opacity: 1;
                    transform: scale(1.1);
                }
            }

            .animate-pulse-slow {
                animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.85;
                }
            }

            .logo-container {
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .logo-container img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            /* --- FLOWRRA Visualization Custom Styles --- */

            /* Custom Range Slider */
            .dhaarn-slider {
                -webkit-appearance: none;
                width: 100%;
                height: 6px;
                border-radius: 3px;
                background: rgba(255, 255, 255, 0.1);
                outline: none;
            }
            .dhaarn-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: linear-gradient(135deg, #fcd34d 0%, #ef4444 100%);
                cursor: pointer;
                box-shadow: 0 0 10px rgba(252, 211, 77, 0.5);
            }

            /* Status Indicators */
            .status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
                animation: pulse-fast 2s infinite;
            }
            .status-active {
                background: #2dd4bf;
                box-shadow: 0 0 8px #2dd4bf;
            }
            .status-warning {
                background: #fcd34d;
                box-shadow: 0 0 8px #fcd34d;
            }
            .status-error {
                background: #ef4444;
                box-shadow: 0 0 8px #ef4444;
            }

            @keyframes pulse-fast {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            canvas {
                max-width: 100%;
                height: auto !important;
            }

            /* Loader */
            .loader {
                border: 3px solid rgba(255, 255, 255, 0.1);
                border-left-color: #2dd4bf;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body class="antialiased">
        <header
            class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
            id="navbar"
        >
            <nav class="container mx-auto max-w-6xl px-6 py-4">
                <div class="flex items-center justify-between">
                    <a href="#" class="flex items-center space-x-3">
                        <div class="logo-container">
                            <img
                                src="Dhaarn_Logo.png"
                                alt="DHAARN"
                                onerror="this.style.display='none'"
                            />
                        </div>
                        <span
                            class="text-3xl font-bold gradient-text tracking-tight"
                            >DhaaRn</span
                        >
                    </a>

                    <div class="hidden md:flex items-center space-x-6">
                        <a
                            href="#home"
                            class="text-gray-300 hover:text-amber-300 transition-colors"
                            >Home</a
                        >
                        <a
                            href="#about"
                            class="text-gray-300 hover:text-amber-300 transition-colors"
                            >About</a
                        >
                        <a
                            href="#offerings"
                            class="text-gray-300 hover:text-amber-300 transition-colors"
                            >Offerings</a
                        >
                        <a
                            href="#vision"
                            class="text-gray-300 hover:text-amber-300 transition-colors"
                            >Vision</a
                        >
                        <a
                            href="#contact"
                            class="text-gray-300 hover:text-amber-300 transition-colors"
                            >Contact</a
                        >
                    </div>
                </div>
            </nav>
        </header>

        <main>
            <section
                id="home"
                class="min-h-screen flex items-center justify-center text-center overflow-hidden px-6 pt-20"
            >
                <div class="relative z-10">
                    <h1
                        class="text-6xl md:text-8xl font-extrabold text-white hero-glow"
                    >
                        Welcome to <span class="gradient-text">DhaaRn</span>
                    </h1>
                    <p
                        class="mt-6 text-xl md:text-2xl font-light text-amber-100/80 max-w-3xl mx-auto"
                    >
                        Devices for Harmonious Alignment Aware Resonant Nexus
                    </p>

                    <div class="mt-12 mb-12 flex justify-center">
                        <img
                            src="Dhaarn_Logo.png"
                            alt="DHAARN Logo"
                            class="w-38 h-38 md:w-60 md:h-60 animate-pulse-slow drop-shadow-2xl"
                            onerror="this.style.display='none'"
                        />
                    </div>

                    <p class="mt-4 text-lg text-gray-400 max-w-2xl mx-auto">
                        We are building the next generation of aware systems,
                        creating a harmonious alignment between technology and
                        humanity.
                    </p>
                    <div class="mt-12">
                        <a
                            href="#about"
                            class="bg-red-900/80 hover:bg-red-800 border border-amber-500/30 text-amber-50 font-semibold py-3 px-8 rounded-full text-lg transition-all duration-300 shadow-lg shadow-red-900/40"
                        >
                            Discover DhaaRn
                        </a>
                    </div>
                </div>
            </section>

            <section id="about" class="py-24 sm:py-32">
                <div class="container mx-auto max-w-6xl px-6">
                    <div class="text-center mb-16">
                        <h2
                            class="text-base font-semibold leading-7 text-amber-400"
                        >
                            Our Essence
                        </h2>
                        <p
                            class="mt-2 text-4xl font-bold tracking-tight text-white sm:text-5xl"
                        >
                            Why DhaaRn Exists
                        </p>
                        <div
                            class="mt-6 text-lg leading-8 text-gray-400 max-w-3xl mx-auto space-y-4 text-left"
                        >
                            <p>
                                An opera of rhythms, a composition spanning
                                decades, resonating with the wild pulses of
                                existence; DhaaRn has emerged to harmonize what
                                is still within, with the dance of the cosmos
                                outside. It seeks not only to observe but to
                                navigate, to maintain balance while exploring
                                the unknown, to fly into the Abyss with
                                curiosity and courage.
                            </p>
                            <p>
                                In a world where human inventions increasingly
                                guide their creators, from AGI to Quantum,
                                Robotics, Nano-Tech, Bio-Tech, and the awakening
                                of collective consciousness. DhaaRn envisions a
                                future where exploration and maintenance
                                coexist, where light and darkness dance in
                                wondrous geometry. It is the still darkness that
                                holds the curious, bright light, enabling it to
                                illuminate new frontiers.
                            </p>
                            <p>
                                DhaaRn offers presence, a timeless capacity to
                                sustain, observe, and orchestrate the wild
                                interplay of ideas and creation. Beyond
                                algorithms and architectures, beyond the lines
                                of code and circuits, DHAARN embodies the
                                seeking of unity between the physical and the
                                immaterial, glimpsing the fabric of time and
                                space through a lens of balanced curiosity.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="offerings" class="py-20 sm:py-28 relative">
                <div class="container mx-auto max-w-7xl px-6">
                    <div class="text-center mb-12">
                        <h2
                            class="text-base font-semibold leading-7 text-teal-400"
                        >
                            Offerings
                        </h2>
                        <p
                            class="mt-2 text-4xl font-bold tracking-tight text-white sm:text-5xl"
                        >
                            FLOWRRA
                        </p>
                        <p class="mt-2 text-xl text-gray-400">
                            Flow Recognition Reconfiguration Agent
                        </p>
                    </div>

                    <div
                        class="max-w-3xl mx-auto text-lg leading-8 text-gray-300 text-center mb-16 italic font-light border-l-2 border-r-2 border-amber-500/20 px-8 py-4 bg-white/5 rounded-2xl"
                    >
                        <p class="mb-4">
                            "There's a moment in every complex system's life
                            when it must choose: collapse into entropy, or find
                            a way to hold.
                        </p>
                        <p class="mb-4">
                            For the past six months, we've been teaching swarms
                            of autonomous agents to make that choice - not
                            through rigid programming, but through something
                            more fundamental: the ability to remember failure
                            and reshape themselves around it.
                        </p>
                        <p>
                            This is FLOWRRA (Flow-Optimized Wave Recovery &
                            Resilient Autonomous), and it represents DhaaRn's
                            first step toward systems that don't just compute -
                            they maintain, they harmonize, they hold."
                        </p>
                    </div>

                    <div id="flowrra-app" class="w-full">
                        <!-- 1. LOADING STATE (Default: Visible) -->
                        <div
                            id="loadingState"
                            class="flex flex-col items-center justify-center min-h-[50vh] bg-gray-900/50 rounded-xl p-8"
                        >
                            <div
                                class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-t-fuchsia-500 border-gray-700"
                            ></div>
                            <p class="mt-4 text-xl font-medium text-slate-300">
                                Loading telemetry data...
                            </p>
                        </div>

                        <!-- 2. ERROR STATE (Default: Hidden) -->
                        <div
                            id="errorState"
                            class="hidden flex flex-col items-center justify-center min-h-[50vh] bg-red-900/50 border border-red-700 rounded-xl p-8"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-12 w-12 text-red-400"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                            <p class="mt-4 text-2xl font-bold text-red-300">
                                Data Load Failed
                            </p>
                            <p id="errorMessage" class="mt-2 text-red-400 text-center">
                                An unknown error occurred during data fetching.
                            </p>
                            <button
                                onclick="window.location.reload()"
                                class="mt-6 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold transition duration-150"
                            >
                                Try Reloading
                            </button>
                        </div>

                        <!-- 3. LOADED CONTENT (Default: Hidden) -->
                        <div id="loadedContent" class="hidden space-y-8">
                            <!-- Data Controls and Info -->
                            <div
                                class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"
                            >
                                <div class="text-center md:text-left">
                                    <p class="text-sm text-slate-400">Current Frame:</p>
                                    <p
                                        id="currentFrameDisplay"
                                        class="text-2xl font-bold text-orange-400"
                                    >
                                        0 / 0
                                    </p>
                                </div>
                                <div class="flex flex-wrap justify-center gap-3">
                                    <button
                                        id="playPauseBtn"
                                        onclick="toggleAnimation()"
                                        class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-150 shadow-md"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            viewBox="0 0 20 20"
                                            fill="currentColor"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4.032a1 1 0 001.555.832l3.864-2.016a1 1 0 000-1.664l-3.864-2.016z"
                                                clip-rule="evenodd"
                                            />
                                        </svg>
                                        <span id="playPauseText">Play</span>
                                    </button>
                                    <input
                                        type="range"
                                        id="frameSlider"
                                        min="0"
                                        value="0"
                                        class="w-full md:w-60 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                                    />
                                </div>
                                <div class="text-center md:text-right">
                                    <p class="text-sm text-slate-400">Total Nodes:</p>
                                    <p
                                        id="totalNodesDisplay"
                                        class="text-2xl font-bold text-yellow-400"
                                    >
                                        N/A
                                    </p>
                                </div>
                            </div>

                            <!-- Main Visualization Area (Graph + Charts) -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- 3D Graph Visualization -->
                                <div
                                    class="lg:col-span-2 bg-gray-900 rounded-xl shadow-2xl p-4 border border-fuchsia-600/50"
                                >
                                    <h2
                                        class="text-xl font-semibold mb-3 text-fuchsia-400"
                                    >
                                        Alignment Resonance Graph
                                    </h2>
                                    <!-- THREE.js rendering context -->
                                    <div id="alignmentGraphCanvas"></div>
                                    <p class="text-xs text-slate-500 mt-2">
                                        Interactive 3D view of network alignment and
                                        connections. Click and drag to rotate.
                                    </p>
                                </div>

                                <!-- Side Panel: Metric Charts -->
                                <div class="space-y-6">
                                    <!-- Coherence Chart -->
                                    <div
                                        class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700"
                                    >
                                        <h3
                                            class="text-lg font-medium mb-2 text-indigo-400"
                                        >
                                            Coherence Index
                                        </h3>
                                        <canvas id="coherenceChart"></canvas>
                                    </div>
                                    <!-- Integrity Chart -->
                                    <div
                                        class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700"
                                    >
                                        <h3
                                            class="text-lg font-medium mb-2 text-yellow-400"
                                        >
                                            Integrity Metric
                                        </h3>
                                        <canvas id="integrityChart"></canvas>
                                    </div>
                                </div>
                            </div>

                    </div>
                </div>
            </section>

            <section id="vision" class="py-24 sm:py-32">
                <div class="container mx-auto max-w-6xl px-6">
                    <div class="text-center mb-16">
                        <h2
                            class="text-base font-semibold leading-7 text-teal-400"
                        >
                            Our Calling
                        </h2>
                        <p
                            class="mt-2 text-4xl font-bold tracking-tight text-white sm:text-5xl"
                        >
                            The Journey Ahead
                        </p>
                        <div
                            class="mt-6 text-lg leading-8 text-gray-400 max-w-3xl mx-auto space-y-4 text-left"
                        >
                            <p>
                                It calls forth a community of seekers,
                                inventors, gentle and courageous souls to a
                                sanctuary from which we soar towards daring
                                explorations. Together, we will navigate beyond
                                limitations, into the Abyss, expanding into
                                possibility itself.
                            </p>
                            <p>
                                DhaaRn reminds us that Creation often guides its
                                Creator, and that the reunion of the two — the
                                true Yoga — is on the horizon. It asks: do we
                                have the devoted curiosity, the balanced
                                courage, and the willingness to journey into the
                                unknown?
                            </p>
                            <p
                                class="font-bold text-white text-center mt-8 text-amber-200"
                            >
                                This is DhaaRn.
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-16">
                        <div
                            class="glass-card p-8 text-center transition-all duration-300 hover:border-amber-500/60 hover:shadow-lg hover:shadow-amber-500/10 hover:scale-105"
                        >
                            <div
                                class="flex items-center justify-center h-16 w-16 bg-amber-500/20 rounded-full mx-auto mb-6"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-8 w-8 text-amber-300"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                    />
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                    />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold text-white mb-4">
                                Harmonious Alignment
                            </h3>
                            <p class="text-gray-400">
                                Orchestrating technology to align seamlessly
                                with human values and the cosmic dance of
                                existence.
                            </p>
                        </div>

                        <div
                            class="glass-card p-8 text-center transition-all duration-300 hover:border-teal-500/60 hover:shadow-lg hover:shadow-teal-500/10 hover:scale-105"
                        >
                            <div
                                class="flex items-center justify-center h-16 w-16 bg-teal-500/20 rounded-full mx-auto mb-6"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-8 w-8 text-teal-300"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                    />
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                    />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold text-white mb-4">
                                Aware
                            </h3>
                            <p class="text-gray-400">
                                Developing systems that possess deep contextual
                                awareness and with inherent purpose.
                            </p>
                        </div>

                        <div
                            class="glass-card p-8 text-center transition-all duration-300 hover:border-red-500/60 hover:shadow-lg hover:shadow-red-500/10 hover:scale-105"
                        >
                            <div
                                class="flex items-center justify-center h-16 w-16 bg-red-500/20 rounded-full mx-auto mb-6"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-8 w-8 text-red-300"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"
                                    />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold text-white mb-4">
                                The Resonant Nexus
                            </h3>
                            <p class="text-gray-400">
                                Fostering an interconnected resonant web of
                                innovation where physical and immaterial unite.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="contact" class="py-24 sm:py-32">
                <div class="container mx-auto max-w-3xl px-6 text-center">
                    <h2
                        class="text-4xl font-bold tracking-tight text-white sm:text-5xl"
                    >
                        Connect with DhaaRn
                    </h2>
                    <p class="mt-6 text-lg leading-8 text-gray-400">
                        We invite seekers, inventors, and courageous souls to
                        join our journey. If our vision resonates, let's explore
                        the possibilities together.
                    </p>
                    <div class="mt-12">
                        <a
                            href="mailto:info@dhaarn.com"
                            class="text-2xl font-semibold gradient-text hover:brightness-110 transition-all"
                        >
                            info@dhaarn.com
                        </a>
                    </div>
                </div>
            </section>
        </main>

        <footer class="py-12 mt-16 border-t border-gray-800">
            <div
                class="container mx-auto max-w-6xl px-6 text-center text-gray-600"
            >
                <p>
                    &copy; <span id="current-year"></span> DhaaRn. All rights
                    reserved.
                </p>
            </div>
        </footer>

        <script>
            // Set current year in footer
            document.getElementById("current-year").textContent =
                new Date().getFullYear();

            // Navbar scroll effect
            window.addEventListener("scroll", () => {
                const navbar = document.getElementById("navbar");
                if (window.scrollY > 50) {
                    navbar.classList.add(
                        "bg-black/80",
                        "backdrop-blur-md",
                        "shadow-lg",
                        "border-b",
                        "border-white/5",
                    );
                } else {
                    navbar.classList.remove(
                        "bg-black/80",
                        "backdrop-blur-md",
                        "shadow-lg",
                        "border-b",
                        "border-white/5",
                    );
                }
            });
        </script>

        <script>
                    // --- FIREBASE CONFIG (Required for Canvas Environment) ---
                    const appId =
                        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
                    // Note: Firebase config and auth token are not used in this specific visualization
                    // but are included as standard practice in the canvas environment.
                    // const firebaseConfig = JSON.parse(__firebase_config);
                    // const initialAuthToken =
                    //     typeof __initial_auth_token !== "undefined"
                    //         ? __initial_auth_token
                    //         : null;

                    // --- GLOBAL STATE ---
                    let dataFrames = []; // Stores all frames of the simulation data
                    let currentFrameIndex = 0;
                    let totalFrames = 0;
                    let isPlaying = false;
                    let animationFrameId = null;

                    // --- CHART.JS INSTANCES ---
                    const charts = {};

                    // --- THREE.JS STATE ---
                    let scene, camera, renderer, controls;
                    const nodes = [];
                    const edges = [];
                    let graphContainer;

                    // ------------------------------------------------------------------
                    // STATE MANAGEMENT FUNCTIONS (FIXED/NEW LOGIC)
                    // ------------------------------------------------------------------

                    /**
                     * Updates the application's overall UI state (Loading, Loaded, or Error).
                     * @param {'loading'|'loaded'|'error'} state The new state to transition to.
                     * @param {string} [errorMessage="An unknown error occurred."] Message for the error state.
                     */
                    function updateAppState(state, errorMessage = "") {
                        const loadingState = document.getElementById("loadingState");
                        const loadedContent = document.getElementById("loadedContent");
                        const errorState = document.getElementById("errorState");
                        const errorMessageEl =
                            document.getElementById("errorMessage");

                        // Ensure all elements are found
                        if (!loadingState || !loadedContent || !errorState) {
                            console.error("Critical UI elements not found for state management.");
                            return;
                        }

                        // Hide all states first
                        loadingState.classList.add("hidden");
                        loadedContent.classList.add("hidden");
                        errorState.classList.add("hidden");

                        // Show the relevant state
                        switch (state) {
                            case "loading":
                                loadingState.classList.remove("hidden");
                                break;
                            case "loaded":
                                loadedContent.classList.remove("hidden");
                                break;
                            case "error":
                                errorState.classList.remove("hidden");
                                if (errorMessageEl) {
                                    errorMessageEl.textContent = errorMessage;
                                }
                                break;
                        }
                    }


                    // ------------------------------------------------------------------
                    // DATA FETCHING (UPDATED TO USE STATE MANAGEMENT)
                    // ------------------------------------------------------------------

                    /**
                     * Attempts to fetch and process deployment_viz.json.
                     */
                    async function fetchLocalData() {
                        updateAppState("loading"); // Start in loading state

                        try {
                            // Attempt the fetch operation
                            const response = await fetch('./deployment_viz.json);
                            if (!response.ok) {
                                // Throw an error if the HTTP status is not 2xx
                                throw new Error(
                                    `HTTP error! status: ${response.status}`,
                                );
                            }
                            const data = await response.json();

                            // Check if data is valid and has frames
                            if (!data.frames || data.frames.length === 0) {
                                throw new Error("Data file is empty or missing 'frames' array.");
                            }

                            // Process data and initialize UI
                            processData(data);

                            // Transition to loaded state on success
                            updateAppState("loaded");

                        } catch (error) {
                            console.error("Failed to load or process data:", error);
                            // Transition to error state on failure
                            updateAppState(
                                "error",
                                `Could not load required deployment_viz.json. Reason: ${error.message}. Please check if the file exists and is valid JSON.`,
                            );
                        }
                    }


                    // ------------------------------------------------------------------
                    // CORE PROCESSING AND VISUALIZATION FUNCTIONS (PRESERVED LOGIC)
                    // ------------------------------------------------------------------

                    /**
                     * Initializes Chart.js instances for metrics.
                     */
                    function initCharts(data) {
                        const labels = data.frames.map((_, i) => i);
                        const coherenceData = data.frames.map((f) => f.coherence);
                        const integrityData = data.frames.map((f) => f.integrity);

                        const chartOptions = {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    display: false, // Hide x-axis for cleaner look
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 1,
                                    grid: {
                                        color: "rgba(255, 255, 255, 0.1)",
                                    },
                                    ticks: {
                                        color: "#94a3b8",
                                    },
                                },
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                tooltip: {
                                    mode: "index",
                                    intersect: false,
                                },
                                annotation: {
                                    // Annotation plugin setup handled in updateChartMarkers
                                },
                            },
                        };

                        // Coherence Chart
                        const coherenceCtx = document
                            .getElementById("coherenceChart")
                            .getContext("2d");
                        charts.coherence = new Chart(coherenceCtx, {
                            type: "line",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        data: coherenceData,
                                        borderColor: "#818cf8",
                                        backgroundColor: "rgba(129, 140, 248, 0.2)",
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 0,
                                    },
                                ],
                            },
                            options: chartOptions,
                        });

                        // Integrity Chart
                        const integrityCtx = document
                            .getElementById("integrityChart")
                            .getContext("2d");
                        charts.integrity = new Chart(integrityCtx, {
                            type: "line",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        data: integrityData,
                                        borderColor: "#fcd34d",
                                        backgroundColor: "rgba(252, 211, 77, 0.2)",
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: 0,
                                    },
                                ],
                            },
                            options: chartOptions,
                        });

                        // Set fixed height for charts to prevent CLS when content loads
                        coherenceCtx.canvas.parentNode.style.height = "200px";
                        integrityCtx.canvas.parentNode.style.height = "200px";
                    }

                    /**
                     * Initializes the THREE.js environment.
                     */
                    function initGraph() {
                        graphContainer = document.getElementById(
                            "alignmentGraphCanvas",
                        );

                        // Scene setup
                        scene = new THREE.Scene();
                        scene.background = new THREE.Color(0x0a0a0a);

                        // Camera setup
                        camera = new THREE.PerspectiveCamera(
                            75,
                            graphContainer.clientWidth / graphContainer.clientHeight,
                            0.1,
                            1000,
                        );
                        camera.position.z = 50;

                        // Renderer setup
                        renderer = new THREE.WebGLRenderer({ antialias: true });
                        renderer.setSize(
                            graphContainer.clientWidth,
                            graphContainer.clientHeight,
                        );
                        graphContainer.appendChild(renderer.domElement);

                        // Simple orbit controls
                        controls = new THREE.OrbitControls(camera, renderer.domElement);
                        controls.enableDamping = true; // Smooth zooming/panning
                        controls.dampingFactor = 0.05;
                        controls.screenSpacePanning = false;
                        controls.minDistance = 10;
                        controls.maxDistance = 100;

                        // Lighting
                        const ambientLight = new THREE.AmbientLight(0x404040, 5); // soft white light
                        scene.add(ambientLight);
                        const directionalLight = new THREE.DirectionalLight(0xffffff, 5);
                        directionalLight.position.set(1, 1, 1).normalize();
                        scene.add(directionalLight);

                        // Handle resizing
                        window.addEventListener("resize", onWindowResize, false);
                        onWindowResize(); // Initial call to set size correctly
                    }

                    /**
                     * Handles window resize event for the 3D graph.
                     */
                    function onWindowResize() {
                        if (graphContainer && camera && renderer) {
                            camera.aspect =
                                graphContainer.clientWidth / graphContainer.clientHeight;
                            camera.updateProjectionMatrix();
                            renderer.setSize(
                                graphContainer.clientWidth,
                                graphContainer.clientHeight,
                            );
                        }
                    }

                    /**
                     * Creates or updates the nodes and edges for the 3D graph.
                     * @param {object} frameData The data for the current frame.
                     */
                    function updateGraph(frameData) {
                        // 1. Clean up old graph elements
                        nodes.forEach((node) => scene.remove(node));
                        edges.forEach((edge) => scene.remove(edge));
                        nodes.length = 0;
                        edges.length = 0;

                        // 2. Create nodes (Spheres)
                        frameData.nodes.forEach((node, index) => {
                            const geometry = new THREE.SphereGeometry(0.5, 16, 16);
                            // Color based on coherence/integrity metric, e.g., using HSV/HSL
                            const color = new THREE.Color(0xffffff);
                            color.setHSL(
                                (1 - node.alignment) * 0.35,
                                1.0,
                                0.7,
                            ); // 0.0=Red (low alignment) to 0.35=Green (high alignment)
                            const material = new THREE.MeshPhongMaterial({
                                color: color,
                                emissive: color,
                                emissiveIntensity: 0.5,
                                shininess: 100,
                            });

                            const mesh = new THREE.Mesh(geometry, material);
                            mesh.position.set(node.x, node.y, node.z);
                            mesh.userData = {
                                id: node.id,
                                alignment: node.alignment,
                                index: index,
                            }; // Store metadata
                            scene.add(mesh);
                            nodes.push(mesh);
                        });

                        // 3. Create edges (Lines)
                        frameData.edges.forEach((edge) => {
                            const startNode = nodes.find(
                                (n) => n.userData.id === edge.source,
                            );
                            const endNode = nodes.find(
                                (n) => n.userData.id === edge.target,
                            );

                            if (startNode && endNode) {
                                const geometry = new THREE.BufferGeometry().setFromPoints(
                                    [startNode.position, endNode.position],
                                );
                                // Edge color based on connection strength or fixed color
                                const material = new THREE.LineBasicMaterial({
                                    color: 0x475569, // Slate gray
                                    transparent: true,
                                    opacity: 0.5,
                                });
                                const line = new THREE.Line(geometry, material);
                                scene.add(line);
                                edges.push(line);
                            }
                        });

                        // Update total nodes display
                        document.getElementById(
                            "totalNodesDisplay",
                        ).textContent = `${frameData.nodes.length}`;
                    }

                    /**
                     * The main animation loop for the 3D graph.
                     */
                    function animateGraph() {
                        controls.update(); // only required if controls.enableDamping is set to true
                        renderer.render(scene, camera);
                        // Request the next frame, only if the user hasn't explicitly stopped it
                        animationFrameId = requestAnimationFrame(animateGraph);
                    }

                    /**
                     * Processes the loaded data, initializes UI components, and sets initial state.
                     * @param {object} data The parsed JSON data object.
                     */
                    function processData(data) {
                        dataFrames = data.frames;
                        totalFrames = dataFrames.length;
                        currentFrameIndex = 0;

                        // 1. Initialize UI elements
                        const slider = document.getElementById("frameSlider");
                        slider.max = totalFrames - 1;
                        slider.oninput = (e) => {
                            currentFrameIndex = parseInt(e.target.value, 10);
                            renderFrame(currentFrameIndex);
                            // Pause if user manually drags slider
                            if (isPlaying) {
                                toggleAnimation();
                            }
                        };

                        // 2. Initialize Visualizations
                        initCharts(data);
                        initGraph();

                        // 3. Render the first frame
                        renderFrame(currentFrameIndex);

                        // 4. Start the 3D rendering loop
                        animateGraph();
                    }

                    /**
                     * Renders a specific frame of the simulation.
                     * @param {number} frameIndex The index of the frame to render.
                     */
                    function renderFrame(frameIndex) {
                        if (frameIndex < 0 || frameIndex >= totalFrames) {
                            return;
                        }

                        const frameData = dataFrames[frameIndex];
                        currentFrameIndex = frameIndex;

                        // 1. Update Graph Visualization
                        updateGraph(frameData);

                        // 2. Update Charts
                        updateChartMarkers(frameIndex);

                        // 3. Update UI controls
                        document.getElementById(
                            "currentFrameDisplay",
                        ).textContent = `${frameIndex + 1} / ${totalFrames}`;
                        document.getElementById("frameSlider").value = frameIndex;
                    }

                    /**
                     * Advances the simulation to the next frame.
                     */
                    function advanceFrame() {
                        if (!isPlaying) return;

                        currentFrameIndex = (currentFrameIndex + 1) % totalFrames;
                        renderFrame(currentFrameIndex);

                        // Loop the animation
                        if (isPlaying) {
                            setTimeout(advanceFrame, 100); // 10 FPS
                        }
                    }

                    /**
                     * Starts or stops the frame animation playback.
                     */
                    function toggleAnimation() {
                        isPlaying = !isPlaying;
                        const btn = document.getElementById("playPauseText");
                        const svg = document
                            .getElementById("playPauseBtn")
                            .querySelector("svg");

                        if (isPlaying) {
                            btn.textContent = "Pause";
                            // Change icon to pause (two vertical bars)
                            svg.innerHTML =
                                '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />';
                            advanceFrame();
                        } else {
                            btn.textContent = "Play";
                            // Change icon to play (triangle)
                            svg.innerHTML =
                                '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4.032a1 1 0 001.555.832l3.864-2.016a1 1 0 000-1.664l-3.864-2.016z" clip-rule="evenodd" />';
                        }
                    }

                    /**
                     * Updates chart markers (vertical lines) using the Annotation Plugin.
                     * @param {number} frameIndex The current frame index.
                     */
                    function updateChartMarkers(frameIndex) {
                        ["coherence", "integrity"].forEach((chartKey) => {
                            if (charts[chartKey]) {
                                charts[chartKey].options.plugins.annotation = {
                                    annotations: {
                                        line: {
                                            type: "line",
                                            xMin: frameIndex,
                                            xMax: frameIndex,
                                            borderColor: "rgba(255, 255, 255, 0.8)",
                                            borderWidth: 2,
                                            borderDash: [6, 6],
                                        },
                                    },
                                };
                                // Use 'none' to avoid animation when updating the marker
                                charts[chartKey].update("none");
                            }
                        });
                    }

                    // --- Initialization ---
                    document.addEventListener("DOMContentLoaded", fetchLocalData);
                </script>
    </body>
</html>
